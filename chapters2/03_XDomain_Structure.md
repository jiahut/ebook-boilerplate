# XDomain Structure

## 概述

业务单据各子域从概念上是正交的, 参考[UserStory](https://wiki.xforceplus.com/display/ECCP/[ECCP][XDomain]+UserStory)  
我们没办法一开始想清楚每个子域所有的字段, 或者从业务上讲字段本身就需要有 "柔性"  
但是XDomain的结构是需要被想清楚的, 在结构上存在共同的部分和一些基本原则  

本节描述XDomain的结构  


## XDomain的数据结构

![img](./img/plantuml-demo.png)  

当我们在谈论结构的时候, 我们其实是在谈如下三个方面的信息:  

-   XDomain数据组织方式  
    -   XDomain数据结构由头和行两个部分组成  
        -   单据头对应到具体单据的头部信息, 由多个字段组成
        -   单据行对应具体业务单据的明细, 由多个字段组成
    -   总体上头和行字段本身没有强绑定关系, 如果有关系需要持久化这种关系  
        -   子域中存在头是由多个行信息汇总起来的情况
        -   子域中也存在头拆分成多个行的情况

-   XDomina中字段的数据类型  
    -   枚举类型
    -   值类型 (来源于外部系统)  
        -   请注意到底应该是文本还是数值类型

-   一些基本原则  
    -   值允许为空值  
        -   **注意: 这里的空值不是默认值, 表示暂时获取不到值或取不到这个值**
    -   每个字段类型下的值都是一维的  
        -   也就是说字段的值肯定不是多个同类型的值组成
        -   注意: 字段的类型可能是一个字典

各个具体的子域在该数据结构的基础上展开对应各自领域的模型  


## XDomain字段的备份属性

XDomain支持子域数据变更的备份, 在此基础上提供支持历史规矩/ 恢复等能力  
一般来讲实现该能力有两种实现方案  

-   snapshot  
    -   将数据变更之前SNAPSHOT一份, 典型的如对虚拟机进行镜像备份
-   diff  
    -   典型的如git commit

相应的, XDomain针对每个字段可以单独设置备份的属性,  

-   数据域  
    -   当字段的备份属性被设为数据域的时候, 会snapshot方式来进行备份

-   状态域  
    -   当字段的备份属性被设为状态域的时候, 会使用diff的方式进行备份

snaphost实现的成本比较大, 对于变化的字段, 优先考虑做成状态域,  

XDomain的场景下, 有这么一个特性:  

**数据的更新一定引起状态的更新, 但状态的更新不一定需要数据更新**  

所以针对更新比较频繁的字段, 请优先使用状态域, 注意 ****XDomain默认是数据域****  


## XDomain各子域通用的字段


### 单据类型

-   在单据头中应该明确指定具体单据的类型以及单据号


### 前置单据

记录该单据的前置单据, 目前仅支持一种前置单据类型, 但是在一种类型下可以包含多个子单据  

-   真实世界中从别的单据转换过来, 需要记录具体转换规则


### 商品信息

商品/服务类型和数量  


### 金额信息

包含是否含税 (增值税) 的金额  
